import{r as t,j as s,B as O}from"./index-6uUUDMWa.js";import{s as n}from"./index-D_rdUX3l.js";import{U as G}from"./index-BwzhNZHn.js";import{R as q}from"./UploadOutlined-CQ-iqRnS.js";import{S as z}from"./index-fJj7ETqQ.js";import{I as _}from"./index-Jl6dzh-W.js";import{C as B}from"./index-DLG8sGys.js";import"./fade-CQEYnZHM.js";import"./useForceUpdate-C8SbLCJF.js";import"./useLocale-CdvqxKGZ.js";import"./PurePanel-Bst78Rcv.js";import"./useVariants-BevnM8xs.js";import"./addEventListener-DXr10HFA.js";import"./index-B3WT-xPw.js";import"./Dropdown-C_SlUWEt.js";const H=f=>new Promise((l,d)=>{const i=new FileReader;i.readAsDataURL(f),i.onload=()=>l(i.result),i.onerror=m=>d(m)}),ne=()=>{const[f,l]=t.useState([]),[d,i]=t.useState(""),[m,j]=t.useState(!1),[N,v]=t.useState([]),[u,S]=t.useState(null),[C,y]=t.useState(!1),[P,I]=t.useState([]),[h,F]=t.useState(null),[L,w]=t.useState(!1);t.useEffect(()=>{w(!0),fetch("http://localhost:5000/get_videos_info").then(e=>e.json()).then(e=>{const o=e.filter(a=>a.category==="person"&&a.processing_status===1).map(a=>({value:JSON.stringify({fileName:a.file_name,id:a.id}),label:a.file_name}));I(o)}).catch(e=>{console.error("获取视频信息出错:",e),n.error("获取视频信息失败")}).finally(()=>{w(!1)})},[]);const R=async e=>{!e.url&&!e.preview&&(e.preview=await H(e.originFileObj)),i(e.url||e.preview),j(!0)},J=({fileList:e})=>{v(e),e.length>0?S(e[0].originFileObj):S(null)},V=e=>{const r=e.type==="image/jpeg"||e.type==="image/png";r||n.error("您只能上传 JPG/PNG 文件!");const o=e.size/1024/1024<2;return o||n.error("图片大小必须小于 2MB!"),v([e]),r&&o},U=({file:e,onSuccess:r})=>{r("ok")},k=()=>{if(!u){n.error("请上传图片");return}if(!h){n.error("请选择数据来源");return}y(!0);const e=new FormData;e.append("image",u);const r=JSON.parse(h);e.append("id",r.id),console.log("videoInfo:",r),l([]),fetch("http://localhost:5000/face-detect",{method:"POST",body:e}).then(o=>{if(o.ok){let a=function(){D.read().then(({done:g,value:M})=>{if(g){console.log("处理完成");return}c+=E.decode(M,{stream:!0});let p=c.indexOf(`
`);for(;p!==-1;){const b=c.slice(0,p).trim();if(c=c.slice(p+1),b)try{const x=JSON.parse(b);l(T=>[...T,x])}catch(x){console.error("解析 JSON 出错:",x)}p=c.indexOf(`
`)}a()}).catch(g=>{console.error("读取流数据出错:",g)})};const D=o.body.getReader();let E=new TextDecoder("utf-8"),c="";a()}else n.error("处理失败")}).catch(o=>{console.error("请求出错:",o),n.error("处理失败")}).finally(()=>{y(!1)})};return s.jsxs("div",{children:[s.jsxs("div",{className:"search",children:[s.jsxs("div",{className:"face_button",children:[s.jsx(G,{listType:"picture",fileList:N,onPreview:R,onChange:J,beforeUpload:V,customRequest:U,children:s.jsx(O,{icon:s.jsx(q,{}),children:"上传人脸"})}),s.jsx(z,{className:"face_select",loading:L,showSearch:!0,placeholder:"选择数据来源",optionFilterProp:"label",filterSort:(e,r)=>((e==null?void 0:e.label)??"").toLowerCase().localeCompare(((r==null?void 0:r.label)??"").toLowerCase()),options:P,onChange:e=>F(e)}),s.jsx(O,{className:"face_button_search",disabled:!u||!h,type:"primary",onClick:k,loading:C,style:{display:"flex",alignItems:"center",justifyContent:"center"},children:"点击查询"})]}),d&&s.jsx(_,{wrapperStyle:{display:"none"},preview:{visible:m,onVisibleChange:e=>j(e),afterOpenChange:e=>!e&&i("")},src:d})]}),s.jsx("div",{className:"pictures",children:f.map((e,r)=>s.jsxs(B,{className:"face_card",children:[s.jsx("div",{className:"face_pic",children:s.jsx(_,{src:e.similar_face,alt:"similar_face"})}),s.jsxs("p",{children:["时间：",e.time]}),s.jsxs("p",{children:["相似度：",((1-e.distance)*100).toFixed(2),"%"]})]},r))})]})};export{ne as default};
